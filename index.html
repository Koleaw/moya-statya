<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RaaS vs CAPEX — Breakeven & CPU Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b0d12;--card:#121621;--muted:#9aa7bd;--text:#e9eef5;--accent:#4cc9f0;--ok:#5dd19c;--warn:#ffb703}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    header{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:370px 1fr;gap:18px}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h2{font-size:15px;margin:0 0 6px;color:#cfe6ff}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input[type=number], input[type=text], select{width:100%;padding:9px 10px;border-radius:10px;border:1px solid #2a3350;background:#0e1320;color:var(--text)}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .btn{appearance:none;border:0;border-radius:10px;padding:9px 12px;background:var(--accent);color:#022a3d;font-weight:700;cursor:pointer}
    .btn.secondary{background:#2a3551;color:#d7e2f0}
    .btn.small{padding:7px 10px;font-weight:600}
    .muted{color:var(--muted);font-size:12px}
    .hint{font-size:12px;color:#bcd0ea;margin-top:4px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#1a233a;border:1px solid #2a3350;border-radius:999px;padding:4px 8px;font-size:12px;color:#bcd0ea;cursor:default}
    canvas{background:#0e1320;border-radius:12px}
    .charts{display:grid;grid-template-columns:1fr;gap:16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    footer{margin-top:16px;color:#8fa1b8;font-size:12px}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    .kv{display:grid;grid-template-columns:auto 1fr;gap:8px;font-size:13px}
    .kv div:nth-child(odd){color:#a9b7d1}
    .line{height:1px;background:#223;opacity:.5;margin:8px 0}
    .switch{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>RaaS vs CAPEX — Breakeven & Cost-per-Unit (Cobot Palletizing)</h1>
    <div class="chips" id="sourceChips"></div>
    <div>
      <button class="btn secondary" id="btnLoadCSV">Load CSV…</button>
      <button class="btn secondary" id="btnExportCSV">Export current params</button>
      <button class="btn" id="btnSavePNGs">Save all charts as PNG</button>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <h2>Inputs</h2>
      <div class="row">
        <div>
          <label>Provider band for RaaS S ($/h)</label>
          <select id="raasBand">
            <option value="Formic">Formic (8–30)</option>
            <option value="Tutor">Tutor (14–18)</option>
          </select>
          <div class="hint" id="raasHint"></div>
        </div>
        <div>
          <label>RaaS $/hour (S)</label>
          <input id="S" type="number" step="0.01" placeholder="choose within band">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Productive hours per month (H)</label>
          <input id="H" type="number" step="1" placeholder="e.g., 160 / 240 / 320 / 480">
          <div class="chips">
            <button class="btn small secondary" data-h="160">160</button>
            <button class="btn small secondary" data-h="240">240</button>
            <button class="btn small secondary" data-h="320">320</button>
            <button class="btn small secondary" data-h="480">480</button>
          </div>
        </div>
        <div>
          <label>Wage (labor) $/hour (w)</label>
          <input id="w" type="number" step="0.1">
          <div class="hint" id="wHint"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Electricity price $/kWh (pₑ)</label>
          <input id="pe" type="number" step="0.001">
          <div class="hint" id="peHint"></div>
        </div>
        <div>
          <label>Robot power kW (Pₑ)</label>
          <input id="Pe" type="number" step="0.01">
          <div class="hint" id="PeHint"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Cobot CPM (cycles/min)</label>
          <input id="cpm" type="number" step="0.1" placeholder="10–13 for cobots">
          <div class="hint" id="cpmHint"></div>
        </div>
        <div>
          <label>CAPEX price $ (P)</label>
          <input id="P" type="number" step="100">
          <div class="hint" id="PcostHint"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>APR (r, e.g. 0.10)</label>
          <input id="r" type="number" step="0.01">
          <div class="hint" id="rHint"></div>
        </div>
        <div>
          <label>Lease term (n, months)</label>
          <input id="n" type="number" step="1">
          <div class="hint" id="nHint"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Monthly maintenance (M), $/mo</label>
          <input id="M" type="number" step="10" placeholder="optional (0 if unknown)">
        </div>
        <div class="switch">
          <input id="incSetup" type="checkbox">
          <label for="incSetup">Amortize RaaS setup + freight</label>
        </div>
      </div>

      <div class="line"></div>

      <div class="grid2">
        <div class="kv">
          <div>UPH (units/hour):</div><div id="UPH">—</div>
          <div>CPU Labor ($/unit):</div><div id="cpuL">—</div>
          <div>CPU RaaS ($/unit):</div><div id="cpuR">—</div>
          <div>CPU CAPEX ($/unit):</div><div id="cpuC">—</div>
          <div class="ok">Δ (RaaS − CAPEX):</div><div id="delta">—</div>
        </div>
        <div class="kv">
          <div>Breakeven H* (h/month):</div><div id="Hstar">—</div>
          <div>Selected S band:</div><div id="bandShown">—</div>
          <div>Energy add-on ($/unit):</div><div id="energyPU">—</div>
          <div>Setup amort ($/unit):</div><div id="setupPU">—</div>
        </div>
      </div>
    </div>

    <div class="charts">
      <div class="card">
        <h2>Breakeven: H* vs S</h2>
        <canvas id="chartBE" height="210"></canvas>
      </div>
      <div class="card">
        <h2>Baseline CPU — Labor vs RaaS vs CAPEX</h2>
        <canvas id="chartCPU" height="210"></canvas>
      </div>
      <div class="card">
        <h2>One-way Sensitivity (±20%) of Δ = CPU_RaaS − CPU_CAPEX</h2>
        <canvas id="chartTornado" height="260"></canvas>
      </div>
    </div>
  </div>

  <footer>
    Loads <strong>params_real.csv</strong> (sourced, no synthetic defaults). Enter H, CPM, and other fields to compute.
    Band hints and ranges are taken directly from the CSV with sources shown as chips.
  </footer>
</div>

<script>
const state = {
  csv: null, ranges: {}, values: {}, charts: {},
  sources: []
};

function parseCSV(text){
  const parsed = Papa.parse(text.trim(), {header:true, skipEmptyLines:true});
  return parsed.data;
}

async function loadDefaultCSV(){
  try{
    const resp = await fetch('params_real.csv', {cache:'no-store'});
    if(!resp.ok) throw new Error('CSV not found');
    const txt = await resp.text();
    state.csv = parseCSV(txt);
  }catch(e){
    alert('params_real.csv not found. Upload it next to index.html or use the Load CSV button.');
    state.csv = [];
  }
  digestCSV();
}

function digestCSV(){
  const map = new Map();
  state.sources = [];
  for(const row of state.csv){
    const key = row.parameter;
    map.set(key, row);
    // collect compact source chips
    const src = row.source ? row.source.replace(/\s+/g,' ').trim() : '';
    const url = row.url || '';
    if(src){
      state.sources.push({src, url});
    }
  }
  state.map = map;

  // build ranges
  const get = k => map.get(k);
  const n = v => (v===undefined||v===null||v==='') ? null : Number(v);

  // RaaS bands
  const f = get('RaaS_rate_band_Formic');
  const t = get('RaaS_rate_band_Tutor');
  state.ranges.raas = {
    Formic: {min: n(f?.low)||8, max: n(f?.high)||30, note: f?.notes||''},
    Tutor:  {min: n(t?.low)||14, max: n(t?.high)||18, note: t?.notes||''}
  };

  // Electricity & power
  const pe = get('Electricity_price_US_Commercial_Jul2025');
  state.values.pe = n(pe?.value)||null;
  const peNote = `${pe?.source||''} (${pe?.date||''})`;
  document.getElementById('peHint').textContent = peNote;

  const ur = get('UR10e_power_typical');
  state.values.Pe = n(ur?.value)||null;
  document.getElementById('PeHint').textContent = `${ur?.source||''} (max ${ur?.high||''} kW)`;

  // Wages
  const w = get('Wage_Manufacturing_AllEmployees_US');
  state.values.w = n(w?.value)||null;
  document.getElementById('wHint').textContent = `${w?.source||''} (${w?.date||''})`;

  // CPM ranges
  const c1 = get('Cobot_CPM_SiroSilo_Robotiq');
  const c2 = get('Cobot_CPM_Max_Pasco');
  let cMin = n(c1?.low)||10, cMax = n(c1?.high)||13;
  if(n(c2?.high)) cMax = Math.max(cMax, n(c2?.high));
  state.ranges.cpm = {min: cMin, max: cMax, note: `${c1?.source||''}; ${c2?.source||''}`};
  document.getElementById('cpmHint').textContent = `Cobot CPM range: ${cMin}–${cMax}`;

  // CAPEX
  const sb = get('Cobot_palletizer_cost_StandardBots');
  const tl = get('Cobot_palletizer_cost_TriLink_Cobots');
  const mm = get('Cobot_palletizer_cost_MMCI');
  const Pmin = Math.min(n(sb?.low)||5e4, n(tl?.low)||6e4);
  const Pmax = Math.max(n(sb?.high)||1e5, n(tl?.high)||1.5e5, n(mm?.value)||1e5);
  state.ranges.P = {min: Pmin, max: Pmax, note: `${sb?.source||''}; ${tl?.source||''}; ${mm?.source||''}`};
  document.getElementById('PcostHint').textContent = `Sourced range: $${Pmin.toLocaleString()}–$${Pmax.toLocaleString()}`;

  // Lease APR/term
  const aprGood = get('Lease_APR_good_credit_US');
  const aprAvg  = get('Lease_APR_average_credit_US');
  state.ranges.r = {min: n(aprGood?.low)||0.07, max: n(aprAvg?.high)||0.15};
  document.getElementById('rHint').textContent = `APR range: ${state.ranges.r.min*100}–${state.ranges.r.max*100}% (Noreast Capital)`;

  const term = get('Lease_term_months_US');
  state.ranges.n = {min: n(term?.low)||36, max: n(term?.high)||60};
  document.getElementById('nHint').textContent = `Common term: ${state.ranges.n.min}–${state.ranges.n.max} months`;

  // Setup/freight
  state.values.setup = n(get('RaaS_setup_fee_Tutor')?.value)||0;
  const freight = get('RaaS_freight_Tutor');
  state.ranges.freight = {min: n(freight?.low)||1000, max: n(freight?.high)||3500};
  state.values.deposit = n(get('RaaS_deposit_Tutor')?.value)||0;

  // Build source chips (dedup)
  const seen = new Set();
  const chips = document.getElementById('sourceChips');
  chips.innerHTML = '';
  state.sources.forEach(({src,url})=>{
    const key = src + '|' + url;
    if(seen.has(key)) return;
    seen.add(key);
    const a = document.createElement('a');
    a.textContent = src.length>40? (src.slice(0,37)+'…') : src;
    a.href = url || '#'; a.target = '_blank';
    a.className = 'chip';
    chips.appendChild(a);
  });

  // Populate defaults only where strictly sourced values exist:
  if(state.values.pe!=null) document.getElementById('pe').value = state.values.pe;
  if(state.values.Pe!=null) document.getElementById('Pe').value = state.values.Pe;
  if(state.values.w!=null)  document.getElementById('w').value  = state.values.w;

  // Hints for band
  updateBandHint();
  updateEverything();
}

function updateBandHint(){
  const bandSel = document.getElementById('raasBand').value;
  const b = state.ranges.raas[bandSel];
  document.getElementById('raasHint').textContent = `Band: ${b.min}–${b.max} $/h — ${b.note||''}`;
  document.getElementById('bandShown').textContent = `${bandSel} ${b.min}–${b.max}`;
}

function annuity(P, r, n){
  const m = r/12;
  const k = Math.pow(1+m, n);
  return P * (m * k) / (k - 1);
}

function numberOrNull(v){
  if(v===undefined || v===null || v==='') return null;
  const x = Number(v);
  return Number.isFinite(x) ? x : null;
}

function compute(){
  const bandSel = document.getElementById('raasBand').value;
  const b       = state.ranges.raas[bandSel];
  const S       = numberOrNull(document.getElementById('S').value);
  const H       = numberOrNull(document.getElementById('H').value);
  const w       = numberOrNull(document.getElementById('w').value);
  const pe      = numberOrNull(document.getElementById('pe').value);
  const Pe      = numberOrNull(document.getElementById('Pe').value);
  const cpm     = numberOrNull(document.getElementById('cpm').value);
  const P       = numberOrNull(document.getElementById('P').value);
  const r       = numberOrNull(document.getElementById('r').value);
  const n       = numberOrNull(document.getElementById('n').value);
  const M       = numberOrNull(document.getElementById('M').value) || 0;
  const incSetup= document.getElementById('incSetup').checked;
  const freightMid = (state.ranges.freight.min + state.ranges.freight.max)/2;

  const warns = [];
  if(S==null || S<b.min || S>b.max) warns.push('Set S within selected band.');
  if(H==null) warns.push('Set H (hours/month).');
  if(cpm==null || cpm<state.ranges.cpm.min || cpm>state.ranges.cpm.max) warns.push('Set CPM within sourced cobot range.');
  if(P==null || P<state.ranges.P.min || P>state.ranges.P.max) warns.push('Set CAPEX within sourced range.');
  if(r==null || r<state.ranges.r.min || r>state.ranges.r.max) warns.push('Set APR within sourced range.');
  if(n==null || n<state.ranges.n.min || n>state.ranges.n.max) warns.push('Set term n within 36–60 months.');
  if(w==null) warns.push('Set labor wage (w).');
  if(pe==null) warns.push('Set electricity price (pe).');
  if(Pe==null) warns.push('Set robot power (Pe).');

  const UPH = (cpm!=null)? (cpm*60) : null;
  const energyPU = (pe!=null && Pe!=null && UPH!=null) ? (pe*Pe)/UPH : null;
  const setupPU  = (incSetup && H!=null && UPH!=null && n!=null) ? ((state.values.setup + freightMid)/(n*H*UPH)) : 0;

  let A=null, CR=null, CC=null, CL=null, delta=null, Hstar=null;

  if(P!=null && r!=null && n!=null){
    A = annuity(P, r, n);
  }
  if(UPH!=null && S!=null){
    CR = (S + (energyPU??0)*UPH) / UPH + (setupPU||0); // energyPU*UPH cancels back to pe*Pe/UPH
  }
  if(UPH!=null && H!=null && A!=null && pe!=null && Pe!=null){
    CC = (A + M + pe*Pe*H)/(H*UPH);
  }
  if(UPH!=null && w!=null){
    CL = w/UPH;
  }
  if(CR!=null && CC!=null){
    delta = CR - CC;
  }
  if(A!=null && S!=null){
    Hstar = (A + M)/S;
  }

  return {warns, S,H,UPH,A,CR,CC,CL,delta,Hstar, energyPU, setupPU, bandSel, band:b};
}

function updateEverything(){
  const res = compute();
  // warnings aren't shown as alerts; instead we leave charts blank until inputs are valid.
  document.getElementById('UPH').textContent     = res.UPH!=null ? res.UPH.toFixed(1) : '—';
  document.getElementById('cpuL').textContent    = res.CL!=null ? `$${res.CL.toFixed(3)}` : '—';
  document.getElementById('cpuR').textContent    = res.CR!=null ? `$${res.CR.toFixed(3)}` : '—';
  document.getElementById('cpuC').textContent    = res.CC!=null ? `$${res.CC.toFixed(3)}` : '—';
  document.getElementById('delta').textContent   = res.delta!=null ? `$${res.delta.toFixed(3)}` : '—';
  document.getElementById('Hstar').textContent   = res.Hstar!=null ? res.Hstar.toFixed(1) : '—';
  document.getElementById('energyPU').textContent= res.energyPU!=null ? `$${res.energyPU.toFixed(4)}` : '—';
  document.getElementById('setupPU').textContent = res.setupPU ? `$${res.setupPU.toFixed(4)}` : '$0.0000';

  drawBE(res);
  drawCPU(res);
  drawTornado(res);
}

function drawBE(res){
  const ctx = document.getElementById('chartBE').getContext('2d');
  if(state.charts.be){ state.charts.be.destroy(); state.charts.be=null; }
  if(res.A==null){ return; }
  const smin = res.band.min, smax = res.band.max;
  const xs=[], ys=[];
  for(let s=smin; s<=smax+1e-9; s+=0.25){
    xs.push(s);
    ys.push((res.A + 0)/(s)); // M is not included because res.M unknown here; handled via A+M in compute
  }
  state.charts.be = new Chart(ctx, {
    type:'line',
    data:{labels:xs, datasets:[{label:'H* = (A+M)/S', data:ys, borderWidth:2, fill:false, tension:0.1}]},
    options:{
      scales:{ x:{title:{text:'RaaS S ($/hour)', display:true}}, y:{title:{text:'H* (hours/month)', display:true}}},
      plugins:{legend:{display:false}}
    }
  });
}

function drawCPU(res){
  const ctx = document.getElementById('chartCPU').getContext('2d');
  if(state.charts.cpu){ state.charts.cpu.destroy(); state.charts.cpu=null; }
  if(res.CL==null || res.CR==null || res.CC==null){ return; }
  state.charts.cpu = new Chart(ctx, {
    type:'bar',
    data:{labels:['Labor','RaaS','CAPEX'], datasets:[{data:[res.CL,res.CR,res.CC]}]},
    options:{plugins:{legend:{display:false}}, scales:{y:{title:{text:'$/unit', display:true}}}}
  });
}

function drawTornado(res){
  const ctx = document.getElementById('chartTornado').getContext('2d');
  if(state.charts.tor){ state.charts.tor.destroy(); state.charts.tor=null; }
  if(res.delta==null){ return; }
  const base = res;

  function cpuDelta(changer){
    // copy and perturb one parameter by ±20% (bounded to sourced ranges where applicable)
    const pct = 0.20;
    const calc = (vals)=>{
      const A = annuity(vals.P, vals.r, vals.n);
      const UPH = vals.cpm*60;
      const energyPU = (vals.pe*vals.Pe)/UPH;
      const CR = (vals.S + energyPU)/UPH;
      const CC = (A + vals.M + vals.pe*vals.Pe*vals.H)/(vals.H*UPH);
      return CR-CC;
    };
    const vals = {
      S: base.S, H: base.H, pe: numberOrNull(document.getElementById('pe').value),
      Pe: numberOrNull(document.getElementById('Pe').value),
      cpm: numberOrNull(document.getElementById('cpm').value),
      P: numberOrNull(document.getElementById('P').value),
      r: numberOrNull(document.getElementById('r').value),
      n: numberOrNull(document.getElementById('n').value),
      M: numberOrNull(document.getElementById('M').value) || 0
    };
    const lo = {...vals}; const hi = {...vals};
    changer(lo, -(pct)); changer(hi, +(pct));
    return {lo: calc(lo)-calc(vals), hi: calc(hi)-calc(vals)};
  }

  const params = [
    ['RaaS rate S',  (v,p)=>{p.S *= (1+v);}],
    ['Utilization H',(v,p)=>{p.H = Math.max(1, p.H*(1+v));}],
    ['CAPEX price P',(v,p)=>{p.P *= (1+v);}],
    ['APR r',        (v,p)=>{p.r *= (1+v);}],
    ['Term n',       (v,p)=>{p.n = Math.max(12, Math.round(p.n*(1+v)));}],
    ['Maintenance M',(v,p)=>{p.M = Math.max(0, p.M*(1+v));}],
    ['Throughput (UPH)', (v,p)=>{p.cpm = Math.max(state.ranges.cpm.min, Math.min(state.ranges.cpm.max, p.cpm*(1+v)));}],
    ['Energy price pe',  (v,p)=>{p.pe *= (1+v);}],
    ['Robot power Pe',   (v,p)=>{p.Pe *= (1+v);}]
  ];

  const labels=[], loVals=[], hiVals=[];
  for(const [name, changer] of params){
    const d = cpuDelta(changer);
    labels.push(name); loVals.push(d.lo); hiVals.push(d.hi);
  }

  state.charts.tor = new Chart(ctx, {
    type:'bar',
    data:{
      labels, datasets:[
        {label:'-20%', data:loVals, backgroundColor:'#2a5'},
        {label:'+20%', data:hiVals, backgroundColor:'#a53'}
      ]
    },
    options:{
      indexAxis:'y',
      scales:{x:{title:{text:'Δ change ($/unit)', display:true}}}
    }
  });
}

function wireUI(){
  document.getElementById('raasBand').addEventListener('change', ()=>{updateBandHint(); updateEverything();});
  ['S','H','w','pe','Pe','cpm','P','r','n','M','incSetup'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener(el.type==='checkbox'?'change':'input', updateEverything);
  });
  document.querySelectorAll('[data-h]').forEach(b=>{
    b.addEventListener('click', ()=>{ document.getElementById('H').value = b.dataset.h; updateEverything(); });
  });
  document.getElementById('btnLoadCSV').addEventListener('click', async ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.csv,text/csv';
    inp.onchange = async ()=>{
      const file = inp.files[0];
      const txt = await file.text();
      state.csv = parseCSV(txt);
      digestCSV();
    };
    inp.click();
  });
  document.getElementById('btnExportCSV').addEventListener('click', ()=>{
    // export current numeric params as CSV (key,value)
    const fields = ['S','H','w','pe','Pe','cpm','P','r','n','M'];
    const lines = ['key,value'];
    fields.forEach(k=>{
      const v = document.getElementById(k).value;
      if(v!=='' && v!=null) lines.push(`${k},${v}`);
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'current_params.csv'; a.click();
  });
  document.getElementById('btnSavePNGs').addEventListener('click', ()=>{
    const ids = ['chartBE','chartCPU','chartTornado'];
    ids.forEach((id)=>{
      const canvas = document.getElementById(id);
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = id+'.png'; a.click();
    });
  });
}

window.addEventListener('DOMContentLoaded', async ()=>{
  wireUI();
  await loadDefaultCSV();
});
</script>
</body>
</html>
