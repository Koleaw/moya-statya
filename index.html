<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RaaS vs CAPEX Calculator (Large Charts)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{ --bg:#ffffff; --fg:#111; --muted:#666; --card:#f6f6f6; --border:#e0e0e0; }
  html,body{background:var(--bg); color:var(--fg); font:16px/1.35 Inter, Roboto, Arial, sans-serif; margin:0}
  .wrap{max-width:1100px; margin:24px auto; padding:0 18px;}
  h1{font-size:22px; margin:0 0 8px;}
  .grid{display:grid; grid-template-columns:360px 1fr; gap:18px;}
  .card{background:var(--card); border:1px solid var(--border); border-radius:10px; padding:14px;}
  .card h2{font-size:16px; margin:0 0 10px;}
  .row{display:grid; grid-template-columns:1.1fr .9fr .7fr; gap:8px; align-items:center; margin-bottom:6px;}
  .row label{font-size:13px; color:var(--muted);}
  .row input{width:100%; padding:6px 8px; border:1px solid var(--border); border-radius:8px;}
  .row .unit{font-size:13px; color:var(--muted); text-align:right;}
  .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
  button{background:#111; color:#fff; border:none; border-radius:8px; padding:8px 10px; cursor:pointer}
  button.secondary{background:#444;}
  .status{font-size:13px; color:var(--muted); margin-top:6px;}
  canvas{background:#fff; border:1px solid var(--border); border-radius:10px; display:block; width:100%; height:380px;}
  #chart-tornado{ height:420px; }
  .grid-charts{display:grid; grid-template-columns:1fr; gap:16px;} /* stack all charts same width */
  .foot{margin-top:10px; font-size:12px; color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">
  <h1>RaaS vs CAPEX Calculator</h1>
  <div class="grid">
    <div class="card">
      <h2>Inputs</h2>
      <div class="row"><label>RaaS price S</label><input id="S" type="number" step="0.01" value="16"><div class="unit">$/h</div></div>
      <div class="row"><label>Hours per month H</label><input id="H" type="number" step="1" value="320"><div class="unit">h/mo</div></div>
      <div class="row"><label>Cycles per minute (CPM)</label><input id="CPM" type="number" step="0.1" value="10"><div class="unit">boxes/min</div></div>
      <div class="row"><label>Robot power P<sub>e</sub></label><input id="Pe" type="number" step="0.01" value="0.35"><div class="unit">kW</div></div>
      <div class="row"><label>Electricity price p<sub>e</sub></label><input id="pe" type="number" step="0.001" value="0.133"><div class="unit">$/kWh</div></div>
      <div class="row"><label>CAPEX price P</label><input id="P" type="number" step="100" value="120000"><div class="unit">$</div></div>
      <div class="row"><label>APR r</label><input id="r" type="number" step="0.001" value="0.10"><div class="unit">1/year</div></div>
      <div class="row"><label>Lease term n</label><input id="n" type="number" step="1" value="48"><div class="unit">months</div></div>
      <div class="row"><label>Maintenance M</label><input id="M" type="number" step="10" value="1500"><div class="unit">$/mo</div></div>
      <div class="row"><label>Labor w</label><input id="w" type="number" step="0.1" value="35.5"><div class="unit">$/h</div></div>
      <div class="row"><label>Setup fee</label><input id="setup" type="number" step="50" value="10000"><div class="unit">$</div></div>
      <div class="row"><label>Freight</label><input id="freight" type="number" step="50" value="2000"><div class="unit">$</div></div>
      <div class="row"><label>Amortize setup+freight</label><input id="amort" type="checkbox" checked><div class="unit"></div></div>
      <div class="btns">
        <button id="recalc">Recalculate</button>
        <button id="save1" class="secondary">Save Breakeven PNG</button>
        <button id="save2" class="secondary">Save CPU PNG</button>
        <button id="save3" class="secondary">Save Sensitivity PNG</button>
      </div>
      <div class="btns">
        <input type="file" id="file" accept=".csv">
        <button id="export" class="secondary">Export current params (CSV)</button>
      </div>
      <div class="status" id="status">Ready.</div>
      <div class="foot">Accepted CSV keys: S,H,CPM,P,r,n,M,w,pe,Pe,setup,freight,amort (0/1). Decimals with dot or comma are OK.</div>
    </div>

    <div class="grid-charts">
      <div class="card">
        <h2>Breakeven H* = (A+M)/S vs S</h2>
        <canvas id="chart-be"></canvas>
      </div>
      <div class="card">
        <h2>Cost per unit</h2>
        <canvas id="chart-bar"></canvas>
      </div>
      <div class="card">
        <h2>Sensitivity (Δ = RaaS − CAPEX, ±20%)</h2>
        <canvas id="chart-tornado"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
Chart.defaults.devicePixelRatio = 2;
Chart.defaults.maintainAspectRatio = false;
Chart.defaults.color = '#111';
Chart.defaults.borderColor = '#d0d0d0';
Chart.defaults.font.family = 'Inter, Roboto, Arial, sans-serif';

const els = id => document.getElementById(id);
const num = v => (typeof v === 'number'? v : parseFloat(String(v||'').replace(',', '.')));
function getInputs(){ return {S:num(els('S').value), H:num(els('H').value), CPM:num(els('CPM').value), Pe:num(els('Pe').value), pe:num(els('pe').value), P:num(els('P').value), r:num(els('r').value), n:num(els('n').value), M:num(els('M').value), w:num(els('w').value), setup:num(els('setup').value), freight:num(els('freight').value), amort:els('amort').checked}; }
function setInputs(o){ for(const k in o){ const e=els(k); if(!e) continue; if(k==='amort') e.checked=!!Number(o[k]); else e.value=num(o[k]); } }
function annuity(P,r,n){ const m=r/12; const pow=Math.pow(1+m,n); return P*(m*pow)/(pow-1); }
function compute(a){ const UPH=60*a.CPM, A=annuity(a.P,a.r,a.n); let CR=(a.S+a.pe*a.Pe)/UPH; if(a.amort){ CR += ((a.setup||0)+(a.freight||0))/(a.n*a.H*UPH); } const CC=(A+a.M+a.pe*a.Pe*a.H)/(a.H*UPH); const CL=a.w/UPH; const Hstar=(A+a.M)/a.S; const energyUnit=(a.pe*a.Pe)/UPH; return {UPH,A,CR,CC,CL,Hstar,energyUnit}; }
const whiteBG={id:'whiteBG',beforeDraw(c){const {ctx,width,height}=c;ctx.save();ctx.globalCompositeOperation='destination-over';ctx.fillStyle='#fff';ctx.fillRect(0,0,width,height);ctx.restore();}};
let beChart, barChart, tornadoChart;

function buildCharts(){
  const a=getInputs(), out=compute(a);
  // Breakeven
  const Svals=[]; for(let s=Math.max(4,a.S-8); s<=Math.max(a.S+12,34); s++) Svals.push(s);
  const A=annuity(a.P,a.r,a.n), Hs=Svals.map(s=>(A+a.M)/s);
  beChart?.destroy();
  beChart=new Chart(els('chart-be'),{type:'line',data:{labels:Svals,datasets:[{label:'H*=(A+M)/S',data:Hs,borderColor:'#111',backgroundColor:'transparent',tension:0.1,pointRadius:0},{label:'Current S',data:Svals.map(s=>s===a.S?(A+a.M)/a.S:null),showLine:false,pointRadius:4,borderColor:'#777',pointBackgroundColor:'#777'}]},options:{plugins:{legend:{labels:{usePointStyle:true}}},scales:{x:{title:{display:true,text:'S ($/h)'}},y:{title:{display:true,text:'H* (h/month)'},beginAtZero:true}}},plugins:[whiteBG]});
  // CPU
  barChart?.destroy();
  barChart=new Chart(els('chart-bar'),{type:'bar',data:{labels:['Labor','RaaS','CAPEX'],datasets:[{label:'$/unit',data:[out.CL,out.CR,out.CC],backgroundColor:['#333','#777','#bbb'],borderColor:['#333','#777','#bbb']}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'$/unit'}}}},plugins:[whiteBG]});
  // Tornado
  const base=out.CR-out.CC, keys=['H','S','P','n','M','CPM','r','pe','Pe','w'], labels=['H','S','P','n','M','CPM','r','pₑ','Pₑ','w'], impacts=[];
  keys.forEach((k,i)=>{const plus={...a}; plus[k]=a[k]*1.2; const minus={...a}; minus[k]=a[k]*0.8; const d1=compute(plus).CR-compute(plus).CC; const d2=compute(minus).CR-compute(minus).CC; impacts.push({label:labels[i],span:Math.max(Math.abs(d1-base),Math.abs(d2-base))});});
  impacts.sort((x,y)=>y.span-x.span);
  tornadoChart?.destroy();
  tornadoChart=new Chart(els('chart-tornado'),{type:'bar',data:{labels:impacts.map(x=>x.label),datasets:[{label:'|Δ change| (±20%)',data:impacts.map(x=>x.span),backgroundColor:'#777',borderColor:'#777'}]},options:{indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{title:{display:true,text:'Absolute change in Δ ($/unit)'}}}},plugins:[whiteBG]});
  els('status').textContent=`UPH=${out.UPH.toFixed(0)}; A=$${out.A.toFixed(0)}/mo; H*=${out.Hstar.toFixed(0)} h/mo; Energy/unit ~ $${out.energyUnit.toExponential(2)}`;
}
function savePNG(chart,name,scale=3){ const old=Chart.defaults.devicePixelRatio; Chart.defaults.devicePixelRatio=scale; chart.update(); const url=chart.canvas.toDataURL('image/png',1.0); const a=document.createElement('a'); a.download=name; a.href=url; a.click(); Chart.defaults.devicePixelRatio=old; chart.update(); }
els('recalc').addEventListener('click', buildCharts);
els('save1').addEventListener('click', ()=>savePNG(beChart,'fig_break_even.png',3));
els('save2').addEventListener('click', ()=>savePNG(barChart,'fig_labor_compare.png',3));
els('save3').addEventListener('click', ()=>savePNG(tornadoChart,'fig_tornado.png',3));
document.getElementById('export').addEventListener('click', ()=>{ const a=getInputs(); const rows=[['key','value','unit','notes'],['S',a.S,'$/h','RaaS price'],['H',a.H,'h/mo','Hours per month'],['CPM',a.CPM,'boxes/min','Throughput'],['Pe',a.Pe,'kW','Robot power'],['pe',a.pe,'$/kWh','Electricity'],['P',a.P,'$','CAPEX'],['r',a.r,'1/year','APR'],['n',a.n,'months','Lease term'],['M',a.M,'$/mo','Maintenance'],['w',a.w,'$/h','Wage'],['setup',a.setup,'$','One-time'],['freight',a.freight,'$','One-time'],['amort',a.amort?1:0,'','1=amortize setup+freight']].map(r=>r.join(',')).join('
'); const blob=new Blob([rows],{type:'text/csv'}); const url=URL.createObjectURL(blob); const link=document.createElement('a'); link.href=url; link.download='params_export.csv'; link.click(); URL.revokeObjectURL(url); });
document.getElementById('file').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; Papa.parse(f,{header:true,skipEmptyLines:true,complete:(res)=>{ const rows=res.data, map={}; rows.forEach(row=>{ const keys=Object.keys(row); let k=(row.key||row.parameter||row.name||row.param||'').toString().trim(); let v=row.value ?? row.val ?? row.default ?? row.Default ?? row['default value']; if(!k){ keys.forEach(h=>{ const kk=h.trim(); if(['S','H','CPM','P','r','n','M','w','pe','Pe','setup','freight','amort'].includes(kk)){ map[kk]=num(row[kk]); } }); } else { const nrm={'s':'S','raas':'S','raas_price':'S','h':'H','hours':'H','cpm':'CPM','p':'P','capex':'P','r':'r','apr':'r','n':'n','months':'n','m':'M','maintenance':'M','w':'w','wage':'w','pe':'pe','power':'Pe','p_e':'pe','setup':'setup','freight':'freight','amort':'amort'}; const nk=nrm[k.toLowerCase()]||k; map[nk]=num(v); } }); if(Object.keys(map).length===0){ els('status').textContent='CSV parsed but no recognized keys'; return; } setInputs(map); buildCharts(); els('status').textContent='CSV loaded.'; }}); });
buildCharts();
</script>
</body>
</html>
